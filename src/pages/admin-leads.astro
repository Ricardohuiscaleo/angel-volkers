---
import AdminLayout from '../layouts/AdminLayout.astro';
export const prerender = false;
---

<AdminLayout title="Admin - Gestión de Leads">
  <div class="space-y-6">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Leads</h1>
        <p class="text-gray-600 mt-1">Gestiona tus clientes potenciales</p>
      </div>
      <button id="addLeadBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
        + Nuevo Lead
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <div class="text-sm text-gray-600">Total Leads</div>
        <div id="totalLeads" class="text-3xl font-bold text-gray-900 mt-2">0</div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <div class="text-sm text-gray-600">Nuevos</div>
        <div id="newLeads" class="text-3xl font-bold text-blue-600 mt-2">0</div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <div class="text-sm text-gray-600">En Contacto</div>
        <div id="contactedLeads" class="text-3xl font-bold text-yellow-600 mt-2">0</div>
      </div>
      <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
        <div class="text-sm text-gray-600">Calificados</div>
        <div id="qualifiedLeads" class="text-3xl font-bold text-green-600 mt-2">0</div>
      </div>
    </div>

    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
      <div class="flex gap-4">
        <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg">
          <option value="">Todos los estados</option>
          <option value="new">Nuevo</option>
          <option value="contacted">Contactado</option>
          <option value="qualified">Calificado</option>
          <option value="converted">Convertido</option>
          <option value="lost">Perdido</option>
        </select>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fuente</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody id="leadsTableBody" class="bg-white divide-y divide-gray-200">
          <tr>
            <td colspan="8" class="px-6 py-4 text-center text-gray-500">Cargando leads...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="leadModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
      <h2 id="modalTitle" class="text-2xl font-bold mb-4">Nuevo Lead</h2>
      <form id="leadForm" class="space-y-4">
        <input type="hidden" id="leadId" />
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
          <input type="text" id="leadName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
          <input type="email" id="leadEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
          <input type="tel" id="leadPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Mensaje</label>
          <textarea id="leadMessage" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Fuente</label>
          <select id="leadSource" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="website">Website</option>
            <option value="chat">Chat</option>
            <option value="phone">Teléfono</option>
            <option value="email">Email</option>
            <option value="referral">Referido</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
          <select id="leadStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
            <option value="new">Nuevo</option>
            <option value="contacted">Contactado</option>
            <option value="qualified">Calificado</option>
            <option value="converted">Convertido</option>
            <option value="lost">Perdido</option>
          </select>
        </div>
        <div class="flex gap-2 pt-4">
          <button type="submit" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Guardar
          </button>
          <button type="button" id="cancelBtn" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let leads: any[] = [];

    async function loadLeads() {
      try {
        const statusFilter = (document.getElementById('statusFilter') as HTMLSelectElement).value;
        const url = statusFilter ? `/api/leads?status=${statusFilter}` : '/api/leads';
        
        const response = await fetch(url);
        leads = await response.json();
        
        updateStats();
        renderLeads();
      } catch (error) {
        console.error('Error loading leads:', error);
      }
    }

    function updateStats() {
      const total = leads.length;
      const newLeads = leads.filter(l => l.status === 'new').length;
      const contacted = leads.filter(l => l.status === 'contacted').length;
      const qualified = leads.filter(l => l.status === 'qualified').length;

      document.getElementById('totalLeads')!.textContent = total.toString();
      document.getElementById('newLeads')!.textContent = newLeads.toString();
      document.getElementById('contactedLeads')!.textContent = contacted.toString();
      document.getElementById('qualifiedLeads')!.textContent = qualified.toString();
    }

    function renderLeads() {
      const tbody = document.getElementById('leadsTableBody')!;
      
      if (leads.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">No hay leads</td></tr>';
        return;
      }

      tbody.innerHTML = leads.map(lead => `
        <tr class="hover:bg-gray-50">
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${lead.name}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${lead.email}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${lead.phone || '-'}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${lead.source}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs font-semibold rounded-full ${getScoreColor(lead.score)}">
              ${lead.score}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(lead.status)}">
              ${getStatusLabel(lead.status)}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
            ${new Date(lead.createdAt).toLocaleDateString('es-CL')}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button onclick="editLead('${lead.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Editar</button>
          </td>
        </tr>
      `).join('');
    }

    function getScoreColor(score: number): string {
      if (score >= 80) return 'bg-green-100 text-green-800';
      if (score >= 50) return 'bg-yellow-100 text-yellow-800';
      return 'bg-red-100 text-red-800';
    }

    function getStatusColor(status: string): string {
      const colors: Record<string, string> = {
        new: 'bg-blue-100 text-blue-800',
        contacted: 'bg-yellow-100 text-yellow-800',
        qualified: 'bg-green-100 text-green-800',
        converted: 'bg-purple-100 text-purple-800',
        lost: 'bg-gray-100 text-gray-800'
      };
      return colors[status] || 'bg-gray-100 text-gray-800';
    }

    function getStatusLabel(status: string): string {
      const labels: Record<string, string> = {
        new: 'Nuevo',
        contacted: 'Contactado',
        qualified: 'Calificado',
        converted: 'Convertido',
        lost: 'Perdido'
      };
      return labels[status] || status;
    }

    (window as any).editLead = function(id: string) {
      const lead = leads.find(l => l.id === id);
      if (!lead) return;

      (document.getElementById('modalTitle') as HTMLElement).textContent = 'Editar Lead';
      (document.getElementById('leadId') as HTMLInputElement).value = lead.id;
      (document.getElementById('leadName') as HTMLInputElement).value = lead.name;
      (document.getElementById('leadEmail') as HTMLInputElement).value = lead.email;
      (document.getElementById('leadPhone') as HTMLInputElement).value = lead.phone || '';
      (document.getElementById('leadMessage') as HTMLTextAreaElement).value = lead.message || '';
      (document.getElementById('leadSource') as HTMLSelectElement).value = lead.source;
      (document.getElementById('leadStatus') as HTMLSelectElement).value = lead.status;
      
      document.getElementById('leadModal')!.classList.remove('hidden');
    };

    document.getElementById('addLeadBtn')!.addEventListener('click', () => {
      (document.getElementById('modalTitle') as HTMLElement).textContent = 'Nuevo Lead';
      (document.getElementById('leadForm') as HTMLFormElement).reset();
      (document.getElementById('leadId') as HTMLInputElement).value = '';
      document.getElementById('leadModal')!.classList.remove('hidden');
    });

    document.getElementById('cancelBtn')!.addEventListener('click', () => {
      document.getElementById('leadModal')!.classList.add('hidden');
    });

    document.getElementById('statusFilter')!.addEventListener('change', loadLeads);

    document.getElementById('leadForm')!.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = (document.getElementById('leadId') as HTMLInputElement).value;
      const data = {
        id: id || undefined,
        name: (document.getElementById('leadName') as HTMLInputElement).value,
        email: (document.getElementById('leadEmail') as HTMLInputElement).value,
        phone: (document.getElementById('leadPhone') as HTMLInputElement).value || undefined,
        message: (document.getElementById('leadMessage') as HTMLTextAreaElement).value || undefined,
        source: (document.getElementById('leadSource') as HTMLSelectElement).value,
        status: (document.getElementById('leadStatus') as HTMLSelectElement).value
      };

      try {
        const method = id ? 'PATCH' : 'POST';
        const response = await fetch('/api/leads', {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          document.getElementById('leadModal')!.classList.add('hidden');
          loadLeads();
        }
      } catch (error) {
        console.error('Error saving lead:', error);
        alert('Error al guardar el lead');
      }
    });

    loadLeads();
  </script>
</AdminLayout>
