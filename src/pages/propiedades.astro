---
import Layout from '../layouts/Layout.astro';
import { prisma } from '../lib/db';

export const prerender = false;

let properties: any[] = [];
try {
  properties = await prisma.property.findMany({
    where: { status: 'available' },
    orderBy: { createdAt: 'desc' },
    take: 12
  });
} catch (error) {
  console.error('Error cargando propiedades:', error);
}

function formatPrice(price: number, currency: string = 'CLP'): string {
  return new Intl.NumberFormat('es-CL', {
    style: 'currency',
    currency,
    minimumFractionDigits: 0,
  }).format(price);
}
---

<Layout title="Propiedades">
  <section class="py-12 bg-gray-50">
    <div class="container mx-auto px-4">
      <h1 class="text-4xl font-bold mb-8">Propiedades Disponibles</h1>
      
      {properties.length === 0 ? (
        <div class="text-center py-20">
          <p class="text-xl text-gray-600">No hay propiedades disponibles</p>
          <p class="text-gray-500 mt-2">Vuelve pronto para ver nuevas opciones</p>
        </div>
      ) : (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {properties.map((p) => (
            <article class="group relative overflow-hidden rounded-lg bg-white shadow-md transition-all hover:shadow-xl">
              <a href={`/propiedades/${p.id}`} class="block">
                <div class="relative aspect-[3/2] overflow-hidden">
                  <img
                    src={p.images[0] || '/placeholder.jpg'}
                    alt={p.title}
                    class="h-full w-full object-cover transition-transform duration-300 group-hover:scale-105"
                    loading="lazy"
                  />
                </div>
                
                <div class="p-4">
                  <p class="text-sm text-gray-600 mb-1">
                    {p.city}, {p.region}, Chile
                  </p>
                  
                  <h2 class="text-lg font-semibold text-gray-900 mb-2">
                    {p.title}
                  </h2>
                  
                  <p class="text-2xl font-bold text-blue-600 mb-3">
                    {formatPrice(p.price, p.currency)}
                  </p>
                  
                  <ul class="flex flex-wrap gap-3 text-sm text-gray-600">
                    {p.bedrooms > 0 && <li>{p.bedrooms} Dorm.</li>}
                    {p.bathrooms > 0 && <li>{p.bathrooms} Baños</li>}
                    <li>{p.area} m²</li>
                  </ul>
                </div>
              </a>
            </article>
          ))}
        </div>
      )}
    </div>
  </section>
</Layout>
