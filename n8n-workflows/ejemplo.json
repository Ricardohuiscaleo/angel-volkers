
Lo destacado de la carpeta
Los flujos de trabajo automatizados para el triage de IA se centran en el procesamiento estructurado de respuestas y el manejo de archivos multimedia (audio/imagen).

{
  "name": "Video YT con seguimientos",
  "nodes": [
    {
      "parameters": {
        "jsonSchemaExample": "{\n  \"response\": {\n    \"part_1\": \"Buen día. Soy el IA Triage de Basdonax. Vamos a ver si realmente puedo ayudar a implementar IA. 3 preguntas rápidas:\\\\n\\\\n\",\n    \"part_2\": \"1) ¿A qué se dedica tu empresa? (breve descripción)\\\\n2) ¿Qué canales usan para interactuar con clientes y cuántos mensajes diarios reciben en total? (WhatsApp, Instagram, Web, Email, otros)\",\n    \"part_3\": \"3) ¿Cuál es el mayor problema hoy con la atención al cliente?\\\\n\\\\n\",\n    \"part_4\": \"Contá las respuestas en este chat. Si hay buen encaje, te voy a enviar una serie de videos explicativos y, después, te paso al WhatsApp oficial con el link.\",\n    \"part_5\": \"Si realmente no hay fit, te comparto el contenido de YouTube para que puedas evaluar sin compromiso. ¿Te parece?\"\n  }\n}",
        "autoFix": true,
        "customizeRetryPrompt": true
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        6400,
        1152
      ],
      "id": "baffc5ea-3b80-415e-92f1-adc18a22cb1d",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "model": "gpt-5-nano-2025-08-07",
        "options": {
          "timeout": 60000,
          "maxRetries": 3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        6144,
        1088
      ],
      "id": "f55de7e3-92ae-4896-b3b9-09df1cbf27b2",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "v9lZfFrk7pXc5Obn",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje a formatear: {{ $json.output }}",
        "hasOutputParser": true,
        "messages": {
          "messageValues": [
            {
              "message": "=Formatea el mensaje que te va a llegar en varias partes, no inventes contenido, solo separa el mensaje que te llega, no inventes nada.\n\nNunca digas en tu respuesta al incio: \"Mensaje a formatear:\", da directamente tu respesta."
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.5,
      "position": [
        6256,
        816
      ],
      "id": "23be010a-2b8e-4bca-b400-c934de067a27",
      "name": "Format Chain",
      "retryOnFail": true,
      "maxTries": 5,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "content": "## Gestión API Whatsapp",
        "height": 880,
        "width": 1692
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3728,
        464
      ],
      "typeVersion": 1,
      "id": "b2019a79-e4fc-4cc9-816f-2c044658f2a9",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## Se estructura y envia en varias partes",
        "height": 1376,
        "width": 6052,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        6048,
        240
      ],
      "typeVersion": 1,
      "id": "64b9f593-c448-402f-a800-49c69ae8f9ac",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('¿respuesta a mensaje?').item.json.url_chatwoot }}api/v1/accounts/1/conversations/{{ $('Input').item.json.body.conversation.messages[0].conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('¿respuesta a mensaje?').item.json.api_key_chatwoot }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": \"{{ $json.content }}\",\n  \"message_type\": \"outgoing\",\n  \"private\": false\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6992,
        1360
      ],
      "id": "1f5e73a3-8f8b-4741-bd82-6115313441c9",
      "name": "HTTP Request3"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        7440,
        752
      ],
      "id": "842b6fd4-f44b-48d9-b9a7-1be19fbe2398",
      "name": "Wait",
      "webhookId": "04226b0c-6b70-4a4c-afe2-d63cb15bb9ba"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8d46d583-b82d-4d85-a0b8-2c30006082a0",
              "leftValue": "={{ $('Format Chain').item.json.output.response.part_2 }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7232,
        848
      ],
      "id": "03e1f0d2-c530-4879-84fb-0e0e47b58c67",
      "name": "If2"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        8240,
        768
      ],
      "id": "e064803d-76b0-4878-978a-9361ae097e9d",
      "name": "Wait1",
      "webhookId": "5566565f-e5c5-466a-a891-488d94158a5d"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3c7eb0e9-13ee-40d6-9738-057a02ac1306",
              "leftValue": "={{ $('Format Chain').item.json.output.response.part_3 }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        7952,
        880
      ],
      "id": "10348c28-f794-430c-a42e-00f28d034efd",
      "name": "If7"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        9040,
        800
      ],
      "id": "a1251835-fb8d-4d90-9d69-ab347624d3d5",
      "name": "Wait2",
      "webhookId": "ef5a778e-e0d6-4bfa-81cb-40b66ee4e983"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3c7eb0e9-13ee-40d6-9738-057a02ac1306",
              "leftValue": "={{ $('Format Chain').item.json.output.response.part_4 }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        8752,
        896
      ],
      "id": "49e16e15-be8d-497d-9fdb-1096a8733e50",
      "name": "If"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        10000,
        752
      ],
      "id": "d675ff94-89f4-4700-9d16-fdc46bf482e8",
      "name": "Wait3",
      "webhookId": "ae8fd048-da52-451c-902a-b47789b29fe5"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "3c7eb0e9-13ee-40d6-9738-057a02ac1306",
              "leftValue": "={{ $('Format Chain').item.json.output.response.part_5 }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        9536,
        912
      ],
      "id": "cd6bab2e-094e-4b58-ba3c-db67603e54d0",
      "name": "If8"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -3040,
        832
      ],
      "id": "c52126f1-d11f-4a84-8f7f-9198eab2113c",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "amount": 30
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        3200,
        832
      ],
      "id": "6174115a-cc4a-414f-b32e-273408feb0ff",
      "name": "Wait6",
      "webhookId": "62ca77bc-b7b4-4499-9b90-0e920909ba36"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        3904,
        1072
      ],
      "id": "8f5b78b0-c57c-4b38-84b0-a492e3a11bf3",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "content": "## Recolectar Mensajes Metodo brasilero",
        "height": 540,
        "width": 1400,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2944,
        688
      ],
      "typeVersion": 1,
      "id": "f1872e30-f963-46e3-9403-c19ed5919f1e",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.7,
      "position": [
        1616,
        656
      ],
      "id": "99ab5178-6404-4557-97fa-8f16f87bfd8b",
      "name": "OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "v9lZfFrk7pXc5Obn",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('Input').item.json.body.attachments[0].data_url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "whatsAppApi",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1360,
        656
      ],
      "id": "8e23073a-9e71-4f64-85e1-1e4b57968061",
      "name": "HTTP Request13",
      "credentials": {
        "whatsAppApi": {
          "id": "khWsYmJu2DtrLCot",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Que hay en esta imagen? describimelo con todo detalle",
        "imageUrls": "={{ $('Datos').item.json.data_url }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.7,
      "position": [
        1600,
        896
      ],
      "id": "c417e248-ee94-45a9-9eb6-79e5cea731ee",
      "name": "OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "v9lZfFrk7pXc5Obn",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e76d5a8e-1040-4e97-88a5-36c54547b11d",
              "leftValue": "={{ $json.timeDifference.seconds }}",
              "rightValue": 5,
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": "=",
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2608,
        624
      ],
      "id": "81748efc-0ef5-40b0-a573-e867595137ee",
      "name": "Menos de 5 segundos?",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "531b8118-2092-4c8a-a013-d840b9da1d6b",
              "leftValue": "={{ $json.body.message_type }}",
              "rightValue": "=incoming",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3696,
        672
      ],
      "id": "40ceeca5-8ae3-406e-bc76-7215c18e795f",
      "name": "incoming?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "73541b8d-e557-47ce-9e87-8a70d4665cb4",
              "leftValue": "={{ $json.body.conversation.messages[0].content }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "46b9c862-4543-4b5b-8ad6-1f18b3bd76c4",
              "leftValue": "={{ $json.body.attachments[0].file_type }}",
              "rightValue": "audio",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "fde2dabf-9e4c-4301-849c-ced1386eae04",
              "leftValue": "={{ $json.body.attachments[0].file_type }}",
              "rightValue": "=image",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "72a3d0b2-03d0-4851-a010-257456c22f85",
              "leftValue": "={{ $json.body.conversation.messages[0].attachments[0].file_type }}",
              "rightValue": "file",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3360,
        656
      ],
      "id": "f90ee8ee-094c-4d5c-90aa-933301f56ab1",
      "name": "Tiene contenido?",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -2384,
        912
      ],
      "id": "a3d2713a-8eea-4534-be59-145675200a63",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {
        "content": "## Bot ON/OFF",
        "height": 1332,
        "width": 1936,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1952,
        320
      ],
      "typeVersion": 1,
      "id": "64444858-8f38-4aa6-8e3c-c04998902d29",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## Tipo de mensaje",
        "height": 1600,
        "width": 2540,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        0,
        0
      ],
      "typeVersion": 1,
      "id": "75e08fce-d60c-48e5-a36a-85366e2879fc",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Datos').first().json.telefono_usuario }}",
        "messageData": "={{ $json.response }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        2992,
        832
      ],
      "id": "74d9472a-40a7-47f6-b4ad-a9625e0575b4",
      "name": "Guarda mensajes",
      "credentials": {
        "redis": {
          "id": "DcoalrTy5Yt6xSHo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensajes",
        "key": "={{ $('Datos').first().json.telefono_usuario }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        3424,
        832
      ],
      "id": "f387397c-2828-454b-80bc-0624d0c80b16",
      "name": "Recupera mensajes",
      "credentials": {
        "redis": {
          "id": "DcoalrTy5Yt6xSHo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8a313a41-eadc-4ada-bc2a-feff79845de9",
              "leftValue": "={{ $json.mensajes.last() }}",
              "rightValue": "={{ $('response').item.json.response }}",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3664,
        832
      ],
      "id": "fc62557d-693c-46eb-8d76-a7cf8352e182",
      "name": "¿terminó de mandar mensajes?"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Datos').first().json.telefono_usuario }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        4192,
        816
      ],
      "id": "aa6faac1-b9b4-459e-97d5-17e8727c3425",
      "name": "Borra mensajes de BD",
      "credentials": {
        "redis": {
          "id": "DcoalrTy5Yt6xSHo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "getTimeBetweenDates",
        "startDate": "={{ $('Input').item.json.body.conversation.messages[0].updated_at }}",
        "endDate": "={{ $json.currentDate }}",
        "units": [
          "second"
        ],
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        -2864,
        624
      ],
      "id": "a42cb525-5e84-430b-b501-581469b480b3",
      "name": "Calcular tiempo entre mensaje y fecha actual"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        -3088,
        624
      ],
      "id": "4ed2f233-ebbc-4b80-9ca2-1381f37fb39a",
      "name": "Fecha actual"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d5f82380-4858-4361-908e-98e45c98f092",
              "name": "mensaje_usuario",
              "value": "={{ $('Recupera mensajes').item.json.mensajes.join() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3936,
        816
      ],
      "id": "4310b1c6-6acb-4259-b530-f903d3070dd9",
      "name": "Paquete de mensajes"
    },
    {
      "parameters": {
        "jsCode": "// Obtenemos todos los items de entrada\nconst items = $input.all();\n\nreturn items.map(item => {\n  const responseIn = item.json.output?.response || {};\n  const response = { ...responseIn };\n\n  for (const [key, val] of Object.entries(response)) {\n    if (typeof val === 'string') {\n      let s = val;\n\n      // 1) Normalizaciones básicas\n      s = s.replace(/[\"“”]/g, \"'\")     // comillas dobles/curvas → simples\n           .replace(/\\r\\n/g, \"\\n\")     // CRLF → LF\n           .replace(/\\n{3,}/g, \"\\n\\n\") // máx 2 saltos seguidos\n           .trim();\n\n      // 2) Des-escapar secuencias literales\n      //    Si tu string trae \"\\\\n\" (dos chars), lo pasamos a salto real\n      s = s.replace(/\\\\n/g, \"\\n\")\n           .replace(/\\\\t/g, \"\\t\");\n\n      response[key] = s;\n    }\n  }\n\n  return {\n    json: {\n      content: response,   // part_1, part_2, etc. con saltos reales\n      message_type: \"outgoing\",\n      private: false\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6720,
        848
      ],
      "id": "a456084e-09c6-435a-91a6-8cd8721e3106",
      "name": "Formatea texto respuesta"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('¿respuesta a mensaje?').item.json.url_chatwoot }}api/v1/accounts/1/conversations/{{ $('Input').item.json.body.conversation.messages[0].conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('¿respuesta a mensaje?').item.json.api_key_chatwoot }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $json.content.part_1 }}"
            },
            {
              "name": "message_type",
              "value": "outgoing"
            },
            {
              "name": "private",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6960,
        848
      ],
      "id": "ea08e06c-65a9-4991-87e7-f374cc8d0d23",
      "name": "1ª Parte Respuesta",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('¿respuesta a mensaje?').item.json.url_chatwoot }}api/v1/accounts/1/conversations/{{ $('Input').item.json.body.conversation.messages[0].conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('¿respuesta a mensaje?').item.json.api_key_chatwoot }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $('Formatea texto respuesta').item.json.content.part_2 }}"
            },
            {
              "name": "message_type",
              "value": "outgoing"
            },
            {
              "name": "private",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7696,
        752
      ],
      "id": "e056dabf-3c0f-445d-a484-3f92ac170ba2",
      "name": "2ª Parte Respuesta",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('¿respuesta a mensaje?').item.json.url_chatwoot }}api/v1/accounts/1/conversations/{{ $('Input').item.json.body.conversation.messages[0].conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('¿respuesta a mensaje?').item.json.api_key_chatwoot }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $('Formatea texto respuesta').item.json.content.part_3 }}"
            },
            {
              "name": "message_type",
              "value": "outgoing"
            },
            {
              "name": "private",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        8432,
        768
      ],
      "id": "a0ca46c4-3ead-4c7c-af9f-807cf3d21e91",
      "name": "3ª Parte Respuesta"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('¿respuesta a mensaje?').item.json.url_chatwoot }}api/v1/accounts/1/conversations/{{ $('Input').item.json.body.conversation.messages[0].conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('¿respuesta a mensaje?').item.json.api_key_chatwoot }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $('Formatea texto respuesta').item.json.content.part_4 }}"
            },
            {
              "name": "message_type",
              "value": "outgoing"
            },
            {
              "name": "private",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        9232,
        800
      ],
      "id": "fec1cb69-7b54-47df-bbb8-22cf7faaac2a",
      "name": "4ª Parte Respuesta"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('¿respuesta a mensaje?').item.json.url_chatwoot }}api/v1/accounts/1/conversations/{{ $('Input').item.json.body.conversation.messages[0].conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('¿respuesta a mensaje?').item.json.api_key_chatwoot }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "={{ $('Formatea texto respuesta').item.json.content.part_5 }}"
            },
            {
              "name": "message_type",
              "value": "outgoing"
            },
            {
              "name": "private",
              "value": "false"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        10240,
        752
      ],
      "id": "bf109191-69d9-4a25-a6ee-3ac9ae01789d",
      "name": "5ª Parte Respuesta"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "55668d32-f96a-4326-8b0e-41d57518e72b",
                    "leftValue": "={{ $json.attachments }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "695c9df0-8e39-4011-a261-e39879c8173e",
                    "leftValue": "={{ $json.attachments }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Imagen"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "34b2a480-9048-4346-bb53-18882ced499b",
                    "leftValue": "={{ $json.attachments }}",
                    "rightValue": "file",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PDF"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.texto }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "exists",
                      "singleValue": true
                    },
                    "id": "1038327d-d5fb-41ee-98ee-3831221d6ad0"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Texto"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        800,
        720
      ],
      "id": "d9eb663b-cda1-4ba5-b6c4-35ef2f468564",
      "name": "Switch"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "095fb2af-b207-483a-b709-b16a9a0919bd",
              "name": "response",
              "value": "={{ $json.response }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2688,
        816
      ],
      "id": "4a71fe64-a5cb-4ac0-9e33-94a5c495e96e",
      "name": "response"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4ee88607-cc89-4b97-b7e0-1f515cbebf33",
              "name": "attachments",
              "value": "={{ $('Input').item.json.body.attachments[0].file_type }}",
              "type": "string"
            },
            {
              "id": "7a0aeb78-3507-4ded-8e5e-ebea56abf488",
              "name": "data_url",
              "value": "={{ $('Input').item.json.body.attachments[0].data_url }}",
              "type": "string"
            },
            {
              "id": "edf79fdb-0c38-4b89-a43d-f182da2c1054",
              "name": "texto",
              "value": "={{ $('Input').item.json.body.content }}",
              "type": "string"
            },
            {
              "id": "c985d5ef-57b2-4e79-84f9-a91a29f21934",
              "name": "On/Off",
              "value": "={{ $('Input').item.json.body.sender.custom_attributes.bot }}",
              "type": "string"
            },
            {
              "id": "af6683ab-966b-4270-ac5b-3e74824214cb",
              "name": "conversation_id",
              "value": "={{ $('Input').item.json.body.conversation.messages[0].conversation_id }}",
              "type": "string"
            },
            {
              "id": "4c7fa68f-4e59-4d37-a293-26899246d4f7",
              "name": "contact_id",
              "value": "={{ $('Input').item.json.body.conversation.contact_inbox.contact_id }}",
              "type": "string"
            },
            {
              "id": "bc61b645-2286-4d02-bbc3-408c84c416ef",
              "name": "telefono_usuario",
              "value": "={{\n  $('Input').item.json.body?.sender?.phone_number\n  ?? $('Input').item.json.body?.conversation?.messages?.[0]?.sender?.additional_attributes?.social_profiles?.instagram\n  ?? $('Input').item.json.body?.conversation?.meta?.sender?.name\n  ?? ''\n}}",
              "type": "string"
            },
            {
              "id": "cf27a001-c234-49ef-b7b6-fafad3f23f3a",
              "name": "respuesta_a_mensaje",
              "value": "={{ $('Input').item.json.body.content_attributes.in_reply_to }}",
              "type": "number"
            },
            {
              "id": "872124d7-fcaf-4427-ab4a-feca63b1ecf7",
              "name": "account_id",
              "value": "={{ $('Input').item.json.body.sender.account.id }}",
              "type": "number"
            },
            {
              "id": "5f6f015f-233d-4464-a959-46de2eebe344",
              "name": "url_chatwoot",
              "value": "",
              "type": "string"
            },
            {
              "id": "e108f6a8-2600-4e91-bc79-5376d439702f",
              "name": "api_key_chatwoot",
              "value": "",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1088,
        1024
      ],
      "id": "82a4fbc9-b975-442d-80c7-0bc4f30ef204",
      "name": "Datos"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d861e70d-6e86-4d61-b10b-80d485805a7b",
              "name": "response",
              "value": "={{ $json.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1920,
        656
      ],
      "id": "49538bef-d9d7-46f5-af06-d2420650ee8a",
      "name": "response (Audio)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "73e483b4-57f0-43b0-a69e-f28fb27dec28",
              "name": "response",
              "value": "={{ $json.content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1936,
        896
      ],
      "id": "e98bae0e-3f06-4627-b46e-0b56931c13cd",
      "name": "response (Imagen)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9e3cc504-cf83-4c47-8b2d-469d52308177",
              "name": "response",
              "value": "=Enviate una imagen. porque enviaste un PDF",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1792,
        1120
      ],
      "id": "3055ffe4-6b18-4c5d-8893-142696dc3ab5",
      "name": "response (PDF)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6aef9fa6-2963-421a-9cde-3078c5c7a69b",
              "name": "response",
              "value": "={{ $('Input').item.json.body.conversation.messages[0].content }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1824,
        1328
      ],
      "id": "8f7c4146-dd2d-493c-8a7d-ac9a18255111",
      "name": "response (Text)"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Que hay en esta imagen? describimelo con todo detalle",
        "imageUrls": "={{ $('Datos').item.json.data_url }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.7,
      "position": [
        1232,
        160
      ],
      "id": "3d70f023-8e5b-4114-a6eb-1c92ed34c89d",
      "name": "OpenAI2",
      "credentials": {
        "openAiApi": {
          "id": "v9lZfFrk7pXc5Obn",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Datos').item.json.telefono_usuario }}",
        "messageData": "={{ $('Datos').item.json.texto }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1040,
        160
      ],
      "id": "8bf85faf-d0ff-47ce-8f4c-9b6b890195ba",
      "name": "Guarda mensajes1",
      "credentials": {
        "redis": {
          "id": "DcoalrTy5Yt6xSHo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "mensajes",
        "key": "={{ $('Datos').first().json.telefono_usuario }}",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1680,
        160
      ],
      "id": "ad0af50f-69a2-4361-a1d5-037603357ea5",
      "name": "Recupera mensajes1",
      "credentials": {
        "redis": {
          "id": "DcoalrTy5Yt6xSHo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Datos').first().json.telefono_usuario }}"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1904,
        160
      ],
      "id": "4714b707-9b28-4d3f-aaf5-0ebf603b8748",
      "name": "Borra mensajes de BD1",
      "credentials": {
        "redis": {
          "id": "DcoalrTy5Yt6xSHo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Datos').first().json.telefono_usuario }}",
        "messageData": "={{ $json.content }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1456,
        160
      ],
      "id": "b26cd431-94d8-4cf5-a6ad-d3615c1a697e",
      "name": "Guarda mensajes2",
      "credentials": {
        "redis": {
          "id": "DcoalrTy5Yt6xSHo",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8c10be58-d54d-4b3f-96b1-39b5ebd36c04",
              "name": "response",
              "value": "=({{ $('Recupera mensajes1').item.json.mensajes[0] }}\n{{ $('Recupera mensajes1').item.json.mensajes[1] }})",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2096,
        160
      ],
      "id": "c8478e0c-3df5-4ab5-be2e-212a2c141b5b",
      "name": "response (texto/imagen)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3bfa16d0-d267-4c4c-930b-16c43a4d9766",
              "name": "mensaje_usuario",
              "value": "={{ $('Paquete de mensajes').item.json.mensaje_usuario }}",
              "type": "string"
            },
            {
              "id": "35cfb6fa-22ac-4cf6-88ce-55a9494feb94",
              "name": "telefono_usuario",
              "value": "={{ $('Datos').first().json.telefono_usuario }}",
              "type": "string"
            },
            {
              "id": "fc96c8ef-0f5f-4d59-a5a0-d1bf1b46010a",
              "name": "conversation_id",
              "value": "={{ $('Datos').first().json.conversation_id }}",
              "type": "string"
            },
            {
              "id": "1d493c80-c01a-4a06-af1a-70f8eb3908e5",
              "name": "contact_id",
              "value": "={{ $('Datos').first().json.contact_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4432,
        832
      ],
      "id": "755cfb6e-dfa8-4cce-9e46-4cfe4586fee6",
      "name": "Input Agente"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "883670f1-378a-4825-98f3-ebc1cb50ff05",
              "leftValue": "={{ $json.texto }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            },
            {
              "id": "5f658066-2129-460b-8026-442485466d60",
              "leftValue": "={{ $json.attachments }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        64,
        672
      ],
      "id": "4b73a01b-195a-4d8a-b101-96bba041328b",
      "name": "¿imagen con texto?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7f72b70f-167b-4b22-93c4-724cc726df1b",
              "leftValue": "={{ $json.respuesta_a_mensaje }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        512,
        640
      ],
      "id": "8cfc6069-e91f-4f7f-bbfd-f1af0c16f683",
      "name": "¿respuesta a mensaje?"
    },
    {
      "parameters": {
        "url": "={{ $json.url_chatwoot }}api/v1/accounts/{{ $json.account_id }}/conversations/{{ $json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $json.api_key_chatwoot }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1344,
        400
      ],
      "id": "7830d8f9-e512-4e1d-9ab5-2b3034076242",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "// 1. messagesList → array de mensajes que devolvió el GET /messages\nconst messagesList = items[0].json.payload;\n\n// 2. webhookItem → la primera vez que disparó tu Webhook ('Input')\nconst webhookItem = $items(\"Input\")[0].json;\n\n// 3. replyId → el ID al que estás respondiendo\nconst replyId = webhookItem.body.content_attributes.in_reply_to;\n\n// 4. Buscamos en el listado el mensaje original\nconst original = messagesList.find(m => m.id === replyId) || {};\n\n// 5. Devolvemos un solo item con el contenido original\nreturn [\n  {\n    json: {\n      originalMessage: original.content || null\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1600,
        400
      ],
      "id": "4f549b47-feca-45c9-bb18-12d190d63a35",
      "name": "Code"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d861e70d-6e86-4d61-b10b-80d485805a7b",
              "name": "response",
              "value": "=Respuesta del cliente sobre el producto/mensaje ({{ $json.originalMessage }}): {{ $('Datos').item.json.texto }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1920,
        400
      ],
      "id": "40824275-848d-45d8-a00c-68652a49436a",
      "name": "response (Audio)1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d5335069-f81a-4ed0-a051-6a7adf506e26",
              "leftValue": "={{ $('Input').item.json.body.conversation.labels }}",
              "rightValue": "humano",
              "operator": {
                "type": "array",
                "operation": "contains",
                "rightType": "any"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1904,
        752
      ],
      "id": "ba12be5e-1d1d-4d98-9436-69219118614f",
      "name": "¿humano?"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => {\n  let output = item.json.output || '';\n\n  if (typeof output === 'string') {\n    output = output\n      .replace(/\"/g, \"'\")        // Comillas dobles normales → simples\n      .replace(/[“”]/g, \"'\")     // Comillas curvas → simples\n      .replace(/\\n{2,}/g, \"\\n\")  // Saltos de línea múltiples → uno solo\n      .replace(/\\n/g, \"\\\\n\");    // Salto de línea → cadena literal \"\\n\"\n  }\n\n  return {\n    json: {\n      content: output,\n      message_type: \"outgoing\",\n      private: false\n    }\n  };\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6768,
        1360
      ],
      "id": "8f72489f-fd8d-4a47-8028-4e99a0d1d38a",
      "name": "Formatea texto respuesta2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('¿respuesta a mensaje?').item.json.url_chatwoot }}api/v1/accounts/1/conversations/{{ $('Input Agente').item.json.conversation_id }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('¿respuesta a mensaje?').item.json.api_key_chatwoot }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": \"{{ $('Formatea texto respuesta').item.json.content }}\",\n  \"message_type\": \"outgoing\",\n  \"private\": false\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        7232,
        1120
      ],
      "id": "039a2974-adf9-42cc-9767-fb10edf492a7",
      "name": "HTTP Request4"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "b8c38fec-2010-4f93-8f6d-9aadae46e89d",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -3984,
        672
      ],
      "id": "058de412-855b-4cf8-bcab-47d15a70377d",
      "name": "Input",
      "webhookId": "b8c38fec-2010-4f93-8f6d-9aadae46e89d"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Input Agente').item.json.telefono_usuario }}1",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        5232,
        1088
      ],
      "id": "ef17d597-baaf-4d63-b381-5746cb575d47",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje usuario: {{ $json.mensaje_usuario }}",
        "options": {
          "systemMessage": "="
        }
      },
      "id": "76a4769c-b63c-4984-97c2-8b6b4743d1d0",
      "name": "AI Facu",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        5248,
        816
      ],
      "retryOnFail": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "model": "gpt-5-mini-2025-08-07",
        "options": {}
      },
      "id": "1949366f-b53b-44a2-9ecd-e9f04db6ba1a",
      "name": "OpenAI Model1",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [
        5088,
        1072
      ],
      "credentials": {
        "openAiApi": {
          "id": "v9lZfFrk7pXc5Obn",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "L7ixqH5aGTiS6G6a",
          "mode": "list",
          "cachedResultName": "Error"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $('Input Agente').item.json.telefono_usuario }}",
            "ultimomensaje": "={{ $('Input Agente').item.json.mensaje_usuario }}",
            "conversation_id": "={{ $('Input Agente').item.json.conversation_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "ultimomensaje",
              "displayName": "ultimomensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        5744,
        912
      ],
      "id": "03df31fa-a5a0-46cb-be21-5a19c9ae3729",
      "name": "Execute Workflow"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c71a2c90-5541-4ebf-b1bb-53e4b1fdc9bb",
              "leftValue": "={{ $json.body.message_type }}",
              "rightValue": "outgoing",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "798d9609-63f8-4c2c-8b56-6e7e52f502cd",
              "leftValue": "={{ $json.body.private }}",
              "rightValue": "false",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "fbde7e55-b6af-4a05-bde9-9b37d9bf6786",
              "leftValue": "={{ $json.body.account.id }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3552,
        944
      ],
      "id": "ba006d8e-05bd-45b4-819d-4b169f8d1341",
      "name": "Outgoing"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.n8n_chat_histories (session_id, message)\nVALUES \n('{{ $('Input').item.json.body.conversation.contact_inbox.source_id }}', '{\"type\": \"human\", \"content\": \"{{ $('Input').item.json.body.content }}\", \"additional_kwargs\": {}, \"response_metadata\": {}}'::jsonb);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1664,
        464
      ],
      "id": "c8056331-80cf-4b7b-8e9f-a3bab11b99cc",
      "name": "Agregar a memoria Agente",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO public.n8n_chat_histories (session_id, message)\nVALUES \n('{{ $('Input').item.json.body.sender.phone_number }}', '{\"type\": \"human\", \"content\": \"{{ $('Input').item.json.body.content }}\", \"additional_kwargs\": {}, \"response_metadata\": {}}'::jsonb);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -3312,
        832
      ],
      "id": "677592b0-375a-4bce-8166-554c8e477113",
      "name": "Agregar a memoria Agente1",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        9776,
        1024
      ],
      "id": "fd3b23b1-1e71-409b-a23d-48ef6f738ff5",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4fffb38a-caf9-44c3-bc26-41433ab675c5",
              "leftValue": "={{ $json.message }}",
              "rightValue": "relation \"conversaciones\" does not exist",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        10160,
        1024
      ],
      "id": "33f4ecd3-0c66-45b5-a2b3-cb7743d2bcc5",
      "name": "If4"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT *\nFROM conversaciones\nWHERE numero = {{ $('Input').item.json.body.conversation.contact_inbox.source_id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        9952,
        1024
      ],
      "id": "b9c2868d-80d6-4f74-ba1c-6cd97cb2226c",
      "name": "Se fija si esta el nro",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "conversaciones",
          "mode": "list",
          "cachedResultName": "conversaciones"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "numero": "={{ $json.numero }}",
            "ultimo_mensaje": "={{ $('Input Agente').item.json.mensaje_usuario }}",
            "ultimo_mensaje_agente": "={{ $json.ultimo_mensaje_agente }}",
            "conversation_id": "={{ $json.conversation_id }}",
            "fecha": "={{ $('Date & Time').item.json.currentDate }}",
            "seguimiento2": "FALSE",
            "seguimiento1": "FALSE"
          },
          "matchingColumns": [
            "numero"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento1",
              "displayName": "seguimiento1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "seguimiento2",
              "displayName": "seguimiento2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ultimo_mensaje_agente",
              "displayName": "ultimo_mensaje_agente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        10816,
        1104
      ],
      "id": "e1b0115c-b346-4c1b-b37e-b78edafc184a",
      "name": "Guarda los nuevos cambios",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "conversaciones",
          "mode": "list",
          "cachedResultName": "conversaciones"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "fecha": "={{ $('Date & Time').item.json.currentDate }}",
            "conversation_id": "={{ $('Input Agente').item.json.conversation_id }}",
            "numero": "={{ $('Input').item.json.body.conversation.contact_inbox.source_id }}",
            "ultimo_mensaje": "={{ $('Input Agente').item.json.mensaje_usuario }}",
            "ultimo_mensaje_agente": "={{ $('AI Facu').item.json.output }}",
            "seguimiento1": "False",
            "seguimiento2": "False"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento1",
              "displayName": "seguimiento1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento2",
              "displayName": "seguimiento2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje_agente",
              "displayName": "ultimo_mensaje_agente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        11040,
        928
      ],
      "id": "8b02ca3b-15a7-40a9-9a27-9739fb3f26e6",
      "name": "Guardar Para Seguimientos1",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE TABLE conversaciones (\n    id SERIAL PRIMARY KEY,\n    fecha TIMESTAMP,\n    numero BIGINT,\n    ultimo_mensaje TEXT,\n    seguimiento1 BOOLEAN,\n    seguimiento2 BOOLEAN,\n    ultimo_mensaje_agente TEXT,\n    conversation_id INT\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        10656,
        928
      ],
      "id": "a101ad63-f8dd-4419-9572-fee82743fde5",
      "name": "Crear tabla si no esta",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "ALTER DATABASE postgres SET TIMEZONE TO 'America/Argentina/Buenos_Aires';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        10832,
        928
      ],
      "id": "abe43ab0-da64-4196-8ec1-888a8394482b",
      "name": "Fecha Argentina",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "38f1fdf3-1476-4655-82f3-8bf0812c0a98",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        10368,
        1120
      ],
      "id": "fc101790-51c4-4b90-bace-7d6d4ba60232",
      "name": "If1"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "conversaciones",
          "mode": "list",
          "cachedResultName": "conversaciones"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "fecha": "={{ $('Date & Time').item.json.currentDate }}",
            "conversation_id": "={{ $('Input Agente').item.json.conversation_id }}",
            "numero": "={{ $('Input').item.json.body.conversation.contact_inbox.source_id }}",
            "ultimo_mensaje": "={{ $('Input Agente').item.json.mensaje_usuario }}",
            "ultimo_mensaje_agente": "={{ $('AI Facu').item.json.output }}",
            "seguimiento1": "False",
            "seguimiento2": "False"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento1",
              "displayName": "seguimiento1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento2",
              "displayName": "seguimiento2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje_agente",
              "displayName": "ultimo_mensaje_agente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        10640,
        1248
      ],
      "id": "25c08b48-fa2f-455d-9f73-1fa8bf2e623e",
      "name": "Guardar Para Seguimientos",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -3344,
        1040
      ],
      "id": "674c2704-9109-41e7-b3ae-bde14cd4713f",
      "name": "No Operation, do nothing3"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        10704,
        480
      ],
      "id": "4587041b-a546-49a9-b4a1-15fe90aa392a",
      "name": "Date & Time1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4fffb38a-caf9-44c3-bc26-41433ab675c5",
              "leftValue": "={{ $json.message }}",
              "rightValue": "relation \"conversaciones\" does not exist",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        11088,
        480
      ],
      "id": "551b568f-2ac9-4e1d-82c8-bc2415a90371",
      "name": "If5"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT *\nFROM conversaciones\nWHERE numero = {{ $('Input').item.json.body.conversation.contact_inbox.source_id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        10880,
        480
      ],
      "id": "2ddc30e1-9172-4ef5-b910-2067e36014a3",
      "name": "Se fija si esta el nro1",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "conversaciones",
          "mode": "list",
          "cachedResultName": "conversaciones"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "numero": "={{ $json.numero }}",
            "ultimo_mensaje": "={{ $('Input Agente').item.json.mensaje_usuario }}",
            "ultimo_mensaje_agente": "={{ $json.ultimo_mensaje_agente }}",
            "conversation_id": "={{ $json.conversation_id }}",
            "fecha": "={{ $('Date & Time1').item.json.currentDate }}",
            "seguimiento2": "FALSE",
            "seguimiento1": "FALSE"
          },
          "matchingColumns": [
            "numero"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento1",
              "displayName": "seguimiento1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "seguimiento2",
              "displayName": "seguimiento2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ultimo_mensaje_agente",
              "displayName": "ultimo_mensaje_agente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        11744,
        560
      ],
      "id": "dbbbd4fd-e652-4e0c-aeb3-349b203734a7",
      "name": "Guarda los nuevos cambios1",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "conversaciones",
          "mode": "list",
          "cachedResultName": "conversaciones"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "fecha": "={{ $('Date & Time1').item.json.currentDate }}",
            "conversation_id": "={{ $('Input Agente').item.json.conversation_id }}",
            "numero": "={{ $('Input').item.json.body.conversation.contact_inbox.source_id }}",
            "ultimo_mensaje": "={{ $('Input Agente').item.json.mensaje_usuario }}",
            "ultimo_mensaje_agente": "={{ $('AI Facu').item.json.output }}",
            "seguimiento1": "False",
            "seguimiento2": "False"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento1",
              "displayName": "seguimiento1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento2",
              "displayName": "seguimiento2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje_agente",
              "displayName": "ultimo_mensaje_agente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        11968,
        384
      ],
      "id": "e4aa5599-ee37-40d8-8f3d-405c7fd68268",
      "name": "Guardar Para Seguimientos2",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE TABLE conversaciones (\n    id SERIAL PRIMARY KEY,\n    fecha TIMESTAMP,\n    numero BIGINT,\n    ultimo_mensaje TEXT,\n    seguimiento1 BOOLEAN,\n    seguimiento2 BOOLEAN,\n    ultimo_mensaje_agente TEXT,\n    conversation_id INT\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        11584,
        384
      ],
      "id": "cdc4d129-2a89-43f3-bef3-e47993737f44",
      "name": "Crear tabla si no esta1",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "ALTER DATABASE postgres SET TIMEZONE TO 'America/Argentina/Buenos_Aires';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        11760,
        384
      ],
      "id": "9a848924-9b3d-4037-b9b1-c2111f6e2bc7",
      "name": "Fecha Argentina1",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "38f1fdf3-1476-4655-82f3-8bf0812c0a98",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        11296,
        576
      ],
      "id": "9a568e2e-1f77-4715-923e-bd4ac475c8c4",
      "name": "If3"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "conversaciones",
          "mode": "list",
          "cachedResultName": "conversaciones"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "fecha": "={{ $('Date & Time1').item.json.currentDate }}",
            "conversation_id": "={{ $('Input Agente').item.json.conversation_id }}",
            "numero": "={{ $('Input').item.json.body.conversation.contact_inbox.source_id }}",
            "ultimo_mensaje": "={{ $('Input Agente').item.json.mensaje_usuario }}",
            "ultimo_mensaje_agente": "={{ $('AI Facu').item.json.output }}",
            "seguimiento1": "False",
            "seguimiento2": "False"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento1",
              "displayName": "seguimiento1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento2",
              "displayName": "seguimiento2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje_agente",
              "displayName": "ultimo_mensaje_agente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        11568,
        704
      ],
      "id": "04ee8772-3356-4c0e-bcaa-1eff271b27b7",
      "name": "Guardar Para Seguimientos3",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "0cc74ab1-1d5d-46f2-adf9-39fad797c7f1",
              "leftValue": "={{ $('Input').item.json.body.conversation.labels }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4656,
        832
      ],
      "id": "299b06c0-896c-4e15-ad83-ac4d46f5e8c1",
      "name": "If6"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Datos').item.json.url_chatwoot }}api/v1/accounts/1/conversations/{{ $('Input Agente').item.json.conversation_id }}/labels",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api_access_token",
              "value": "={{ $('Datos').item.json.api_key_chatwoot }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"labels\": [\n    \"lead\"\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4864,
        976
      ],
      "id": "cb114954-a565-40ae-bed4-555e8b5f35f0",
      "name": "Etiquetar lead"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-5-nano-2025-08-07",
          "mode": "list",
          "cachedResultName": "gpt-5-nano-2025-08-07"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        6384,
        1312
      ],
      "id": "22a50005-7d63-4da9-9583-3d23562069fc",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "v9lZfFrk7pXc5Obn",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get"
      },
      "type": "n8n-nodes-base.googleDocsTool",
      "typeVersion": 2,
      "position": [
        5408,
        1360
      ],
      "id": "130fce4d-aed5-4056-98a8-be3e9ff631c4",
      "name": "Servicios_Basdonax",
      "credentials": {
        "googleDocsOAuth2Api": {
          "id": "Q30aGPI5kVJKX0Ht",
          "name": "Google Docs account"
        }
      }
    },
    {
      "parameters": {
        "description": "Etiqueta al usuario como NO calificado.",
        "workflowId": {
          "__rl": true,
          "value": "NYsHur1CIGPVvkrN",
          "mode": "list",
          "cachedResultName": "Lead NO calificado"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $('Input Agente').item.json.telefono_usuario }}",
            "ultimomensaje": "={{ $('Input Agente').item.json.mensaje_usuario }}",
            "conversation_id": "={{ $('Input Agente').item.json.conversation_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number"
            },
            {
              "id": "ultimomensaje",
              "displayName": "ultimomensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        5600,
        1360
      ],
      "id": "2ca72f7b-229d-4870-87ff-f02552ab32a9",
      "name": "No_calificado"
    },
    {
      "parameters": {
        "description": "Si el usuario esta calificado y listo para llamada, activa esta herramienta.",
        "workflowId": {
          "__rl": true,
          "value": "6pWCRKeKtuOkU7EN",
          "mode": "list",
          "cachedResultName": "Listo_llamada"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telefono": "={{ $('Input Agente').item.json.telefono_usuario }}",
            "ultimomensaje": "={{ $('Input Agente').item.json.mensaje_usuario }}",
            "conversation_id": "={{ $('Input Agente').item.json.conversation_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telefono",
              "displayName": "telefono",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "ultimomensaje",
              "displayName": "ultimomensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        5760,
        1360
      ],
      "id": "766ebbdc-5ce8-47b3-90e2-e83ceb329a3b",
      "name": "Listo_llamada"
    },
    {
      "parameters": {
        "content": "# Herramientas Agente\n",
        "height": 304,
        "width": 608,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5296,
        1232
      ],
      "typeVersion": 1,
      "id": "d2ce9c7c-24ac-4d0c-985c-fe17a6122d8b",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        -1472,
        464
      ],
      "id": "1b0249d5-28b4-4609-a7fc-0f277599c9d7",
      "name": "Date & Time2"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4fffb38a-caf9-44c3-bc26-41433ab675c5",
              "leftValue": "={{ $json.message }}",
              "rightValue": "relation \"conversaciones\" does not exist",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1120,
        464
      ],
      "id": "579c2086-2633-470d-b80f-7d99a19e1daf",
      "name": "If9"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT *\nFROM conversaciones\nWHERE numero = {{ $('Input').item.json.body.conversation.contact_inbox.source_id }};",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1328,
        464
      ],
      "id": "84db3457-2826-45bf-9c39-e689b0b4efa7",
      "name": "Se fija si esta el nro2",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "conversaciones",
          "mode": "list",
          "cachedResultName": "conversaciones"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "numero": "={{ $json.numero }}",
            "ultimo_mensaje": "={{ $('Input').item.json.body.content }}",
            "ultimo_mensaje_agente": "={{ $json.ultimo_mensaje_agente }}",
            "conversation_id": "={{ $json.conversation_id }}",
            "fecha": "={{ $('Date & Time2').item.json.currentDate }}",
            "seguimiento2": "FALSE",
            "seguimiento1": "FALSE"
          },
          "matchingColumns": [
            "numero"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento1",
              "displayName": "seguimiento1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "seguimiento2",
              "displayName": "seguimiento2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ultimo_mensaje_agente",
              "displayName": "ultimo_mensaje_agente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -464,
        544
      ],
      "id": "86caaa41-4164-4bce-bf18-f12750e7012c",
      "name": "Guarda los nuevos cambios2",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "conversaciones",
          "mode": "list",
          "cachedResultName": "conversaciones"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "fecha": "={{ $('Date & Time2').item.json.currentDate }}",
            "conversation_id": "={{ $('Input Agente').item.json.conversation_id }}",
            "numero": "={{ $('Input').item.json.body.conversation.contact_inbox.source_id }}",
            "ultimo_mensaje": "={{ $('Input Agente').item.json.mensaje_usuario }}",
            "ultimo_mensaje_agente": "={{ $('AI Facu').item.json.output }}",
            "seguimiento1": "False",
            "seguimiento2": "False"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento1",
              "displayName": "seguimiento1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento2",
              "displayName": "seguimiento2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje_agente",
              "displayName": "ultimo_mensaje_agente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -240,
        368
      ],
      "id": "b3b085f8-bbdf-47d2-a02e-69038e499b46",
      "name": "Guardar Para Seguimientos4",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CREATE TABLE conversaciones (\n    id SERIAL PRIMARY KEY,\n    fecha TIMESTAMP,\n    numero BIGINT,\n    ultimo_mensaje TEXT,\n    seguimiento1 BOOLEAN,\n    seguimiento2 BOOLEAN,\n    ultimo_mensaje_agente TEXT,\n    conversation_id INT\n);",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -624,
        368
      ],
      "id": "35834211-c096-4b46-8fec-d1e035e54a58",
      "name": "Crear tabla si no esta2",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "ALTER DATABASE postgres SET TIMEZONE TO 'America/Argentina/Buenos_Aires';",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -448,
        368
      ],
      "id": "cd2eaf22-061f-4a3d-b32c-141c6b3ea57d",
      "name": "Fecha Argentina2",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "38f1fdf3-1476-4655-82f3-8bf0812c0a98",
              "leftValue": "={{ $json.id }}",
              "rightValue": "",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -912,
        560
      ],
      "id": "ffa0f9db-e0aa-40db-8ffa-3c2a248853be",
      "name": "If10"
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "conversaciones",
          "mode": "list",
          "cachedResultName": "conversaciones"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "fecha": "={{ $('Date & Time2').item.json.currentDate }}",
            "conversation_id": "={{ $('Input Agente').item.json.conversation_id }}",
            "numero": "={{ $('Input').item.json.body.conversation.contact_inbox.source_id }}",
            "ultimo_mensaje": "={{ $('Input Agente').item.json.mensaje_usuario }}",
            "ultimo_mensaje_agente": "={{ $('AI Facu').item.json.output }}",
            "seguimiento1": "False",
            "seguimiento2": "False"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "numero",
              "displayName": "numero",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje",
              "displayName": "ultimo_mensaje",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento1",
              "displayName": "seguimiento1",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "seguimiento2",
              "displayName": "seguimiento2",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ultimo_mensaje_agente",
              "displayName": "ultimo_mensaje_agente",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "conversation_id",
              "displayName": "conversation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -640,
        688
      ],
      "id": "837038ce-e288-47c8-ab85-af8f6baa1721",
      "name": "Guardar Para Seguimientos5",
      "credentials": {
        "postgres": {
          "id": "pMwiRQzARhRemSM5",
          "name": "Postgres account"
        }
      },
      "onError": "continueRegularOutput"
    }
  ],
  "pinData": {},
  "connections": {
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Format Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Format Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Format Chain": {
      "main": [
        [
          {
            "node": "Formatea texto respuesta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Formatea texto respuesta2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "2ª Parte Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If2": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "3ª Parte Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If7": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "4ª Parte Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait3": {
      "main": [
        [
          {
            "node": "5ª Parte Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If8": {
      "main": [
        [
          {
            "node": "Wait3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Date & Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait6": {
      "main": [
        [
          {
            "node": "Recupera mensajes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI1": {
      "main": [
        [
          {
            "node": "response (Audio)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request13": {
      "main": [
        [
          {
            "node": "OpenAI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI": {
      "main": [
        [
          {
            "node": "response (Imagen)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Menos de 5 segundos?": {
      "main": [
        [
          {
            "node": "¿humano?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "incoming?": {
      "main": [
        [
          {
            "node": "Tiene contenido?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Outgoing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tiene contenido?": {
      "main": [
        [
          {
            "node": "Fecha actual",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guarda mensajes": {
      "main": [
        [
          {
            "node": "Wait6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recupera mensajes": {
      "main": [
        [
          {
            "node": "¿terminó de mandar mensajes?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿terminó de mandar mensajes?": {
      "main": [
        [
          {
            "node": "Paquete de mensajes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Borra mensajes de BD": {
      "main": [
        [
          {
            "node": "Input Agente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular tiempo entre mensaje y fecha actual": {
      "main": [
        [
          {
            "node": "Menos de 5 segundos?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fecha actual": {
      "main": [
        [
          {
            "node": "Calcular tiempo entre mensaje y fecha actual",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Paquete de mensajes": {
      "main": [
        [
          {
            "node": "Borra mensajes de BD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatea texto respuesta": {
      "main": [
        [
          {
            "node": "1ª Parte Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1ª Parte Respuesta": {
      "main": [
        [
          {
            "node": "If2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HTTP Request4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2ª Parte Respuesta": {
      "main": [
        [
          {
            "node": "If7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3ª Parte Respuesta": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4ª Parte Respuesta": {
      "main": [
        [
          {
            "node": "If8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "HTTP Request13",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OpenAI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "response (PDF)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "response (Text)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "response": {
      "main": [
        [
          {
            "node": "Guarda mensajes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Datos": {
      "main": [
        [
          {
            "node": "¿imagen con texto?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "response (Audio)": {
      "main": [
        [
          {
            "node": "response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "response (Imagen)": {
      "main": [
        [
          {
            "node": "response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "response (PDF)": {
      "main": [
        [
          {
            "node": "response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "response (Text)": {
      "main": [
        [
          {
            "node": "response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI2": {
      "main": [
        [
          {
            "node": "Guarda mensajes2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guarda mensajes1": {
      "main": [
        [
          {
            "node": "OpenAI2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Recupera mensajes1": {
      "main": [
        [
          {
            "node": "Borra mensajes de BD1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guarda mensajes2": {
      "main": [
        [
          {
            "node": "Recupera mensajes1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Borra mensajes de BD1": {
      "main": [
        [
          {
            "node": "response (texto/imagen)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "response (texto/imagen)": {
      "main": [
        [
          {
            "node": "response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input Agente": {
      "main": [
        [
          {
            "node": "If6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿imagen con texto?": {
      "main": [
        [
          {
            "node": "Guarda mensajes1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "¿respuesta a mensaje?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿respuesta a mensaje?": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "response (Audio)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "response (Audio)1": {
      "main": [
        [
          {
            "node": "response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "¿humano?": {
      "main": [
        [
          {
            "node": "Agregar a memoria Agente",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatea texto respuesta2": {
      "main": [
        [
          {
            "node": "HTTP Request3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input": {
      "main": [
        [
          {
            "node": "incoming?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Facu",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Facu",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Facu": {
      "main": [
        [
          {
            "node": "Format Chain",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute Workflow",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Outgoing": {
      "main": [
        [
          {
            "node": "Agregar a memoria Agente1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time": {
      "main": [
        [
          {
            "node": "Se fija si esta el nro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If4": {
      "main": [
        [
          {
            "node": "Crear tabla si no esta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Se fija si esta el nro": {
      "main": [
        [
          {
            "node": "If4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear tabla si no esta": {
      "main": [
        [
          {
            "node": "Fecha Argentina",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fecha Argentina": {
      "main": [
        [
          {
            "node": "Guardar Para Seguimientos1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Guarda los nuevos cambios",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Para Seguimientos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time1": {
      "main": [
        [
          {
            "node": "Se fija si esta el nro1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "Crear tabla si no esta1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Se fija si esta el nro1": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear tabla si no esta1": {
      "main": [
        [
          {
            "node": "Fecha Argentina1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fecha Argentina1": {
      "main": [
        [
          {
            "node": "Guardar Para Seguimientos2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If3": {
      "main": [
        [
          {
            "node": "Guarda los nuevos cambios1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Para Seguimientos3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5ª Parte Respuesta": {
      "main": [
        [
          {
            "node": "Date & Time1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If6": {
      "main": [
        [
          {
            "node": "AI Facu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Etiquetar lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Etiquetar lead": {
      "main": [
        [
          {
            "node": "AI Facu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Structured Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Servicios_Basdonax": {
      "ai_tool": [
        [
          {
            "node": "AI Facu",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "No_calificado": {
      "ai_tool": [
        [
          {
            "node": "AI Facu",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Listo_llamada": {
      "ai_tool": [
        [
          {
            "node": "AI Facu",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time2": {
      "main": [
        [
          {
            "node": "Se fija si esta el nro2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If9": {
      "main": [
        [
          {
            "node": "Crear tabla si no esta2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Se fija si esta el nro2": {
      "main": [
        [
          {
            "node": "If9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crear tabla si no esta2": {
      "main": [
        [
          {
            "node": "Fecha Argentina2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fecha Argentina2": {
      "main": [
        [
          {
            "node": "Guardar Para Seguimientos4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If10": {
      "main": [
        [
          {
            "node": "Guarda los nuevos cambios2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Para Seguimientos5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "f5717eac-2b7c-4a3b-bd37-5ded42786c42",
  "meta": {
    "instanceId": "7d393e3d4387d7bfab5035e922364ae3e35b5d04683f8008433460e184f28e4c"
  },
  "id": "qKOz3731dLjXI5AC",
  "tags": [
    {
      "createdAt": "2025-08-28T19:41:00.449Z",
      "updatedAt": "2025-08-28T19:41:00.449Z",
      "id": "VOq8t3WlVt8edbvh",
      "name": "WhatsApp"
    },
    {
      "createdAt": "2025-08-28T19:40:56.718Z",
      "updatedAt": "2025-08-28T19:40:56.718Z",
      "id": "kK8NGImTTfbMyyPW",
      "name": "Basdonax Agent"
    }
  ]
}